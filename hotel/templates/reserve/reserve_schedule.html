{% extends 'account/base.html' %}
{% load static %}

{% block vendors-css %}
<link rel="stylesheet" href="{% static 'vendor/libs/perfect-scrollbar/perfect-scrollbar.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/node-waves/node-waves.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/typeahead-js/typeahead.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/fullcalendar/fullcalendar.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/flatpickr/flatpickr.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/quill/editor.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/formvalidation/dist/css/formValidation.min.css' %}" />
<link href="{% static 'css/mobiscroll.javascript.min.css' %}" rel="stylesheet" />
<script src="{% static 'js/mobiscroll.javascript.min.js' %}"></script>

<!-- Bootstrap JavaScript (bundle includes Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}

{% block page-css %}
<link rel="stylesheet" href="{% static 'vendor/css/pages/app-calendar.css' %}" />

<style>
.room1{
 border-bottom: 4px solid #003C43 !important;
 min-height: 52px !important;
}
.room1.mbsc-timeline-resource {
  background:  rgba(246, 231, 203, 0.7);
}
.room3{
 border-bottom: 4px solid #77B0AA !important;
 min-height: 52px !important;
}
.room3.mbsc-timeline-resource {
  background:  rgba(246, 231, 203, 0.7);
}
.room5{
 border-bottom: 4px solid #ADBC9F !important;
 min-height: 52px !important;
}
.room5.mbsc-timeline-resource {
  background:  rgba(246, 231, 203, 0.7);
}
.room7{
 border-bottom: 4px solid #C6EBC5 !important;
 min-height: 52px !important;
}
.room7.mbsc-timeline-resource {
  background:  rgba(246, 231, 203, 0.7);
}
.room8{
 border-bottom: 4px solid #F9E897 !important;
 min-height: 52px !important;
}
.room8.mbsc-timeline-resource {
  background: rgba(246, 231, 203, 0.7);
}
.room9{
 border-bottom: 4px solid #F2C18D !important;
 min-height: 52px !important;
}
.room9.mbsc-timeline-resource {
  background: rgba(246, 231, 203, 0.7);
}
.room10{
 border-bottom: 4px solid #A3333D !important;
 min-height: 52px !important;
}
.room10.mbsc-timeline-resource {
  background:  rgba(246, 231, 203, 0.7);
}
.room11{
 border-bottom: 4px solid #e3c3c6 !important;
 min-height: 52px !important;
}
.room11.mbsc-timeline-resource {
  background:  rgba(246, 231, 203, 0.7);
}
.room12{
  border-bottom: 4px solid #590531 !important;
  min-height: 52px !important;
}
.room12.mbsc-timeline-resource {
  background: rgba(246, 231, 203, 0.7);
}
.mbsc-timeline-header .mbsc-flex .mbsc-ios .mbsc-rtl{
  background: rgba(246, 231, 203, 0.7) !important;
  font-weight: bold;
  
}
@media (min-width: 769px) {
.mbsc-timeline-resource-col, .mbsc-timeline-sidebar-col{
 width: 85px;
 } 
} 
@media (max-width: 768px) {
.mbsc-timeline-resource-col, .mbsc-timeline-sidebar-col{
 width: 45px;
} 
}

.container-xxl .flex-grow-1 .container-p-y{
 padding-right:0px;
}
.mbsc-timeline-column, .mbsc-timeline-header-column{
 width: 100px;
}
.mbsc-timeline-event-background{
  height: 42px !important;
}
@media (min-width: 769px) {
.mbsc-timeline-resource-title{
  text-align: center;
  font-size: 1em;
}
.mbsc-form-control-wrapper{
    border-style:solid !important;
    border-color:rgb(198, 198, 198) !important;
    border-radius: 15px !important;
  }
.mbsc-bt-cotrol-today{
    margin-left: 5px;
    padding: 5px;
    background-color:white;
}
}
@media (max-width: 768px) {
  .mbsc-timeline-resource-title {
    text-align: center;
    font-size: 0.7em;
  }
  .mbsc-form-control-wrapper{
    border-style:solid !important;
    border-color:rgb(198, 198, 198) !important;
    border-radius: 15px !important;
    font-size: 0.7rem;
  }
  .mbsc-bt-cotrol-today{
    margin-left: 5px;
    padding: 5px;
    background-color:white;
  }
}
.mbsc-calendar-controls{
  justify-content: center !important;
}
/* .mbsc-timeline-day-border{
  border-left: 3px solid rgb(198, 192, 192) !important; 
}  */
.md-lunch-break-class.mbsc-schedule-invalid {
    text-align: center;
    align-items: center;
    font-weight: bold;
    background: repeating-linear-gradient(-45deg, #f3f3f3, #f3f3f3 6px, #e5e5e5 11px, #e5e5e5 22px);
    background-color: #a9a9a99c !important;
}
.mbsc-button-mycalendar{
  background-color: #FFFFFF !important;
  /* border-radius: 15px; */
  margin: 20px;
  font-weight: bold;
}

.custom-toast-container {
        position: fixed !important;
        left: 20px;
        z-index: 1050;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
  <div class="card app-calendar-wrapper">
    <div class="row g-0">
      <!-- Calendar & Modal -->
      <div id="demo-add-delete-event" class="md-date-header-template mbsc-cloak md-pages">
      </div>
      <div style="display: none">
        <div id="demo-add-popup">
              <div class="mbsc-form-group" style="margin: 20px;">
                <div class="row">
                  <!-- First Column -->
                  <div class="col-md-6 col-6">
                    <label for="event-title">نام</label>
                    <input type="text" class="form-control input" id="event-title" name="event-title" required>
                    
                    {% if request.user.user_status != "verified" %}  
                    <label for="event-status">وضعیت</label>
                    <select class="form-control" id="event-status" name="event-status" required>
                      <option value="pending_payment">در انتظار پرداخت</option>
                      <option value="confirmed">تایید شده</option>
                      <option value="closetime">غیرقابل رزرو</option>
                    </select>
                    {% endif %}  
                    <span id="event-capacity" name="event-capacity"></span><br>
                    <input type="number" class="form-control" id="event-more-capacity" name="event-more-capacity"><br>
                    <label for="event-cleaning">نظافت:</label>
                    <input type="checkbox" id="event-cleaning" name="event-cleaning">
                    <label for="event-paid">پرداخت حضوری:</label>
                    <input type="checkbox" id="event-paid" name="event-paid">
                  </div>
                  <!-- Second Column -->
                  <div class="col-md-6 col-6">
                  {% if request.user.user_status != "verified" %}
                    <label for="event-user">شماره تلفن</label>
                    <input type="text" class="form-control input" id="event-user"  name="event-user" required>
                  {% endif %}
                    <label for="event-resource">اتاق</label>
                    <select class="form-control" id="event-resource" name="event-resource" required>
                      {% for resources in resources %}
                      <option value="{{resources.id}}">{{resources.name}}</option>
                      {% endfor %}
                    </select>
                    <label for="event-price-per-person">قیمت هر نفر مازاد</label>
                    <span class="form-control" id="event-price-per-person" name="event-price-per-person"></span>
                    <label for="event-price">قیمت هر شب</label>
                    <span class="form-control" id="event-price" name="event-price"></span>
                  </div>
                </div>
              </div>
              <div class="mbsc-form-group">
                <div mbsc-page class="demo-range-select">
                  <div style="height:100%">
                    <div id="demo-range-selection"></div>
                  </div>
                </div>
                <div class="mbsc-button-group">
                  <button class="mbsc-button-block" id="event-delete" mbsc-button data-color="danger" data-variant="outline">حذف رزرو</button>
                  <button class="mbsc-button-block" id="event-pay" mbsc-button data-color="danger" data-variant="outline">پرداخت</button>
                  <!-- <button class="mbsc-button-block" id="event-reminder" mbsc-button data-color="submit" data-variant="outline">ارسال پیامک یادآوری</button> -->
                </div>
              </div>
        </div>
      </div>
    </div>
  </div>
  <div >
    {% if messages %}
        <div class="toast-container custom-toast-container" >
            {% for message in messages %}
                <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true">
                    <div class="toast-header">
                        <strong class="me-auto">{{ message.tags }}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        {{ message }}
                    </div>
                </div>
            {% endfor %}
            <hr>
        </div>
    {% endif %}
</div>  
</div>   
<script>
// Define the status-to-color mapping

mobiscroll.setOptions({
    locale: mobiscroll.localeFa,
    theme: 'ios',
    themeVariant: 'light'
});

var reservationData = {{ reservation_data|safe }};
var resourceData = {{ resource_data|safe }};
var invalidreservation = {{ closed_time_data|safe }};
const statusColorMapping = {
  pending_payment: '#fcd200',
  confirmed: '#72fc00',
  cleaning: '#DD5746',  
};
// Call the function and update the reservations array to add css color for calendar 
function addColorToReservations(reservations, statusColorMapping) {
  return reservations.map(reservation => {
    const color = statusColorMapping[reservation.status] || '#000000'; // Provide a default color if status is not in the mapping
     
    return { ...reservation, color: color, cssClass: 'md-lunch-break-class mbsc-flex ' };
  });
}

// Call the function and update the reservations array to add css class for calendar 
const reservations_with_css = addColorToReservations(reservationData, statusColorMapping);

function addCssClassToReservations(reservations) {
  return reservations.map(reservation => {
    return { ...reservation, cssClass: `md-lunch-break-class mbsc-flex room${reservation.id}` };
  });
}

const resourceData_with_css = addCssClassToReservations(resourceData);
const invalidreservation_with_css = addCssClassToReservations(invalidreservation);

var popup, oldEvent, tempEvent = {}, deleteEvent;
var startcalendar = '2024-04-20';
var endcalendar = '2025-04-20';
var deleteButton = document.getElementById('event-delete');

// Initialize datepicker for reservation
var datepickerreserve = mobiscroll.datepicker('#demo-range-selection', {
    controls: ['calendar'],
    display: 'inline',
    selectCounter: true,
    focusOnOpen: true,
    rangeSelectMode: 'wizard',
    select: 'range',
    showRangeLabels: true
});

function createAddPopup(elm, resourceId, tempEvent) {
    deleteButton.style.display = 'none';

    deleteEvent = true;
    restoreEvent = false;

    // Reset form fields
    $('#event-title').val('');
    {% if request.user.user_status != "verified" %}
    $('#event-status').val('');
    {% endif %}
    $('#event-user').val('');
    $('#event-buffer').val('');
    $('#start-input').val('');
    $('#end-input').val('');
    $('#event-resource').val(resourceId);

    var matchingResource = resourceData.find(resource => resource.id === resourceId);

    $('#event-capacity').text(`${matchingResource.capacity} نفر مجاز + ${matchingResource.max_capacity} نفر`);
    $('#event-price').text(matchingResource.price);
    $('#event-cleaning').prop('checked', true);
    $('#event-more-capacity').val(0);
    $('#event-paid').prop('checked', false);
    $('#event-price-per-person').text(matchingResource.price_per_person);

    
    firstday = tempEvent.start;
    lastday = tempEvent.end;
    datepickerreserve.setVal([firstday, lastday]);

    popup.open();
    popup.setOptions({
        headerText: 'افزودن رزرو',
        buttons: [
            'cancel',
            {% if request.user.user_status != "verified" %}
            {
                text: 'ذخیره',
                keyCode: 'enter',
                handler: function () {
                    var reservtime = datepickerreserve.getVal();
                    const startreserve = new Date(reservtime[0]);
                    const endreserve = new Date(reservtime[1]);
                    deleteEvent = false;
                    addReservation({
                        title: $('#event-title').val(),
                        {% if request.user.user_status == "verified" %}
                            mobile_number: "{{request.user.mobile_number}}",
                        {% else %}
                           mobile_number: $('#event-user').val(),
                        {% endif %}
                        start: startreserve.toISOString(),
                        end: endreserve.toISOString(),
                        resource: $('#event-resource').val(),
                        {% if request.user.user_status != "verified" %}
                        status: $('#event-status').val(),
                        {% else %}
                        status: "pending_payment",
                        {% endif %}
                        cleaning: $('#event-cleaning').prop('checked'),
                        more_capacity: $('#event-more-capacity').val(),
                        paid: $('#event-paid').prop('checked'),
                    });
                    popup.close();
                },
                
                cssClass: 'mbsc-popup-button-primary'
            },
            {% endif %}
        ],
        anchor: elm,
        position: { top: 'auto', left: 'auto', right: 'auto', bottom: 'auto' }
    });


    var eventResourceSelect = document.getElementById('event-resource');
    
    eventResourceSelect.addEventListener('change', function () {
        var selectedOption = eventResourceSelect.options[eventResourceSelect.selectedIndex];
        var resourceId = parseInt(selectedOption.value);
        
        var matchedResource = resourceData.find(resource => resource.id === resourceId);
        $('#event-resource').val(resourceId);
        $('#event-capacity').text(`${matchedResource.capacity} نفر مجاز + ${matchedResource.max_capacity} نفر`);
        $('#event-price').text(matchedResource.price);
        $('#event-cleaning').prop('checked', true);
        $('#event-more-capacity').val(0);
        $('#event-paid').prop('checked', false);
        $('#event-price-per-person').text(matchedResource.price_per_person);
      });
 
    
    document.getElementById('event-pay').addEventListener('click', async function () {
        var reservtime = datepickerreserve.getVal();
        const startreserve = new Date(reservtime[0]);
        const endreserve = new Date(reservtime[1]);
        deleteEvent = false;
        try {
            const reservationId = await addReservation({
                title: $('#event-title').val(),
                {% if request.user.user_status != "verified" %}
                    mobile_number: {{request.user.mobile_number }},
                {% else %}
                    mobile_number: $('#event-user').val(),
                {% endif %}                
                start: startreserve.toISOString(),
                end: endreserve.toISOString(),
                resource: $('#event-resource').val(),
                status: $('#event-status').val(),
                cleaning: $('#event-cleaning').prop('checked'),
                more_capacity: $('#event-more-capacity').val(),
                paid: $('#event-paid').prop('checked'),
                total_pay: totalCost
            });
            console.log('Reservation added successfully with ID:', reservationId);
            window.location.href ="/reserve/bill/" + reservationId + "/"; // Redirect to purchase settings
        } catch (error) {
            console.log('Failed to add reservation.');
        }
        
        
    });
}

function addReservation(data) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: 'reserve/add_reservation/',
            method: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                ...data
            },
            success: function (response) {
                if (response.success) {
                    myCalendar.refresh();
                    resolve(response.reservation_id);
                    location.reload(true);
                } else {
                    reject(null);
                }
            },
            error: function () {
                reject(null);
                location.reload(true);
            }
        });
    });
}


function createEditPopup(args, resourceId) {
    var ev = args.event;
    
    var matchingResource = resourceData.find(resource => resource.id === resourceId);
    
    firstday = ev.start;
    lastday = ev.end;
    datepickerreserve.setVal([firstday, lastday]);
    
    
    deleteButton.style.display = 'block';
    deleteEvent = false;
    restoreEvent = true;

    popup.setOptions({
        headerText: 'مشخصات رزرو',
        buttons: [
            'cancel',
            {#{#}
            {#    text: 'ویرایش',#}
            {#    keyCode: 'enter',#}
            {#    handler: function () {#}
            {#        var reservtime = datepickerreserve.getVal();#}
            {#        const startreserve = new Date(reservtime[0]);#}
            {#        const endreserve = new Date(reservtime[1]);#}
            {#        #}
            {#        deleteEvent = false;#}
            {#        updateReservation({#}
            {#            title: $('#event-title').val(),#}
            {#            {% if request.user.user_status == "verified" %}#}
            {#                mobile_number: "{{request.user.mobile_number}}",#}
            {#            {% else %}#}
            {#                mobile_number: $('#event-user').val(),#}
            {#            {% endif %}#}
            {#            start: startreserve.toISOString(),#}
            {#            end: endreserve.toISOString(),#}
            {#            resource: $('#event-resource').val(),#}
            {#            {% if request.user.user_status != "verified" %}#}
            {#            status: $('#event-status').val(),#}
            {#            {% else %}#}
            {#            status: "pending_payment",#}
            {#            {% endif %}#}
            {#            cleaning: $('#event-cleaning').prop('checked'),#}
            {#            more_capacity: $('#event-more-capacity').val(),#}
            {#            paid: $('#event-paid').prop('checked'),#}
            {#            price: totalCost#}
            {#        },ev.reserve_id);#}
            {#        #}
            {#        popup.close();#}
            {#    },                #}
            {#    cssClass: 'mbsc-popup-button-primary'#}
            {##}
        ],
        anchor: args.domEvent.currentTarget,
        position: { top: 'auto', left: 'auto', right: 'auto', bottom: 'auto' }
    });

    fetchReservationInfo(ev.reserve_id);
}

{#function updateReservation(data,reserve_id) {#}
{#        $.ajax({#}
{#            url: 'reserve/update_reservation/' + reserve_id + "/",#}
{#            method: 'POST',#}
{#            data: {#}
{#                csrfmiddlewaretoken: '{{ csrf_token }}',#}
{#                ...data#}
{#            },#}
{#            success: function (response) {#}
{#                if (response.success) {#}
{#                    myCalendar.refresh();#}
{#                    location.reload(true);#}
{#                } else {#}
{#                    console.log("add error", response);#}
{#                }#}
{#            }#}
{#        });#}
{##}

function fetchReservationInfo(reservation_id) {
    $.ajax({
        url: 'reserve/get_reservation_info/',
        method: 'GET',
        data: { reservation_id: reservation_id },
        success: function (data) {
            fillPopupWithData(data);
            popup.open();
        },
        error: function () {
            alert('خطا در دریافت اطلاعات رزرو');
        }
    });
}

function fillPopupWithData(data) {
    $('#event-title').val(data.title);
    $('#event-status').val(data.status);
    $('#event-buffer').val(data.bufferAfter);
    $('#event-buffer').prop('checked', data.bufferAfter);
    $('#event-user').val(data.mobile_number);
    $('#start-input').val(data.start);
    $('#end-input').val(data.end);
    $('#event-resource').val(data.resources);
    $('#event-cleaning').prop('checked', data.cleaning);
    $('#event-capacity').text(`${data.capacity} نفر مجاز + ${resourceData.find(resource => resource.id === data.resources).max_capacity} نفر`);
    $('#event-more-capacity').val(data.morecapacity);
    $('#event-paid').prop('checked', data.paid);
    $('#event-price').text(data.price);
    $('#event-price-per-person').text(data.price_per_person);

    firstday = data.start;
    lastday = data.end;
    datepickerreserve.setVal([firstday, lastday]);
}

var now = new Date();
var yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
var myCalendar = mobiscroll.eventcalendar('#demo-add-delete-event', {
    locale: mobiscroll.localeFa,
    clickToCreate: 'double',
    dragToCreate: true,
    dragToMove: false,
    dragToResize: false,
    rtl: true,
    view: {
        timeline: {
            type: 'year',
            size: 30
        }
    },
    invalid: invalidreservation_with_css,
    data: reservations_with_css,
    resources: resourceData_with_css,
    renderHeader: function () {
        return `
            <div class="mbsc-form-control-wrapper mbsc-bt-cotrol-today">
                <div mbsc-calendar-today></div>
            </div>
            <div id="custom-date-range"></div>
            <label>شروع: <input id="start" mbsc-input placeholder="کلیک کنید" /></label>
            <label>پایان: <input id="end" mbsc-input placeholder="کلیک کنید" /></label>
        `;
    },
    onPageLoaded: function (args) {
        startDate = args.firstDay;
        endDate = new Date(args.lastDay.getFullYear(), args.lastDay.getMonth(), args.lastDay.getDate() - 1, 0);
    },
    onEventClick: function (args) {
        tempEvent = args.event;
        resourceId = args.event.resource;
        if (!popup.isVisible()) {
            createEditPopup(args, resourceId);
        }
    },
    onEventCreated: function (args) {
        resourceId = args.event.resource;
        tempEvent = args.event;
        createAddPopup(args.target, resourceId, tempEvent);
    },
    onEventDeleted: function (args) {
        mobiscroll.snackbar({
            button: {
                action: function () {
                    myCalendar.addEvent(args.event);
                },
                text: 'Undo'
            },
            message: 'Event deleted'
        });
    }
});

popup = mobiscroll.popup('#demo-add-popup', {
    display: 'bottom',
    contentPadding: false,
    fullScreen: true,
    onClose: function () {
        if (deleteEvent) {
            myCalendar.removeEvent(tempEvent);
        } else if (restoreEvent) {
            myCalendar.updateEvent(oldEvent);
        }
    },
    responsive: {
        medium: {
            display: 'anchored',
            width: 400,
            height: 1200,
            fullScreen: false,
            touchUi: false
        }
    }
});

deleteButton.addEventListener('click', function () {
    var deletedEvent = tempEvent;
    myCalendar.removeEvent(tempEvent);
    $.ajax({
        url: 'reserve/remove_reservation/' + tempEvent.reserve_id,
        method: 'GET',
        success: function (response) {
            console.log(response)
            popup.close();
        },
        error: function (response) {
            console.log(response)
            alert('خطا در دریافت اطلاعات رزرو');
        }
    });
});

var myRange = mobiscroll.datepicker('#custom-date-range', {
    select: 'range',
    startInput: '#start',
    endInput: '#end',
    display: 'center',
    showOverlay: false,
    locale: mobiscroll.localeFa,
    touchUi: true,
    rtl: true,
    buttons: [],
    onClose: function (args) {
        if (args.value.length > 1) {
            myCalendar.setOptions({
                startDay: args.value[0],
                endDay: args.value[1]
            });
            myCalendar.navigate(args.value[0]);
        }
    }
});
</script>

    
<!-- Include Bootstrap JS for Toast -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var toastElList = [].slice.call(document.querySelectorAll('.toast'))
        var toastList = toastElList.map(function (toastEl) {
            return new bootstrap.Toast(toastEl, { delay: 1000000000 });
        });
        toastList.forEach(toast => toast.show());
    });
</script>
    
{% endblock %}


{% block vondors-js %}
<script src="{% static 'vendor/libs/fullcalendar/fullcalendar.js' %}"></script>
<script src="{% static 'vendor/libs/formvalidation/dist/js/FormValidation.min.js' %}"></script>
<script src="{% static 'vendor/libs/formvalidation/dist/js/plugins/Bootstrap5.min.js' %}"></script>
<script src="{% static 'vendor/libs/formvalidation/dist/js/plugins/AutoFocus.min.js' %}"></script>
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
<script src="{% static 'vendor/libs/jdate/jdate.js' %}"></script>
<script src="{% static 'vendor/libs/flatpickr/flatpickr-jdate.js' %}"></script>
<script src="{% static 'vendor/libs/flatpickr/fa-jdate.js' %}"></script>
<script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
{% endblock %}

{% block page-js %}
        
<script src="{% static 'js/app-calendar-events.js' %}"></script>
<script src="{% static 'js/app-calendar.js' %}"></script>
<!-- / Content -->
<script src="https://cdn.jsdelivr.net/npm/moment/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment-jalaali/build/moment-jalaali.min.js"></script>
{% endblock %}
